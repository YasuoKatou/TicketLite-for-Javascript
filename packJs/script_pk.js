var _vw_popup=[[{type:'block',id:'popup',child:[{type:'def-list',child:[{type:'title',class:'menu_group',text:'チケット',items:[{id:'hm_search',class:'menu_item',data:{page:'#view01'},text:'検索'},{id:'hm_project',class:'menu_item',data:{page:'#view02'},text:'プロジェクト'}]},{type:'title',class:'menu_group',text:'マスタ',items:[{id:'hm_user',class:'menu_item',data:{page:'#page_user'},text:'ユーザ'},{id:'hm_role',class:'menu_item',data:{page:'#page_role'},text:'ロール'},{id:'hm_p_stat',class:'menu_item',data:{page:'#view03'},text:'プロジェクト'},{id:'hm_t_stat',class:'menu_item',data:{page:'#page_t_stat'},text:'チケット状態'},{id:'hm_t_kind',class:'menu_item',data:{page:'#page_t_kind'},text:'チケット種類'},{id:'hm_t_prgs',class:'menu_item',data:{page:'#page_t_prgs'},text:'チケット進捗'},{id:'hm_t_pri',class:'menu_item',data:{page:'#page_t_pri'},text:'チケット優先順位'}]}]}]}],[{type:'block',class:'popup_body-01',child:[{type:'block',id:'popup-01-guid',text:'ガイダンス'},{type:'block',id:'popup-01-data',child:[]},{type:'block',id:'popup-01-ope',child:[{type:'inp-button',id:'popup-01-new',text:'新規'},{type:'inp-button',id:'popup-01-update',text:'更新'}]}]}]];var _popup_list_01={type:'block',id:'popup_list_01',class:'list_01_wrapper',child:[]};var _login_vw_body=[{type:'block',class:'form-inp-area',child:[{type:'inp-text',name:'user-id',placeholder:'ユーザIDを入力',class:'inp-required',label:{text:'ユーザID',class:'title'}},{type:'inp-passwd',name:'passwd',placeholder:'パスワードを入力',class:'inp-required',label:{text:'パスワード',class:'title'}}]},{type:'block',class:'form-btn-area',child:[{type:'inp-submit',id:'btn-login',text:'ログイン'},{type:'inp-reset',text:'クリア'}]}];var _login_view={title:'login view',root:'login',child:[{type:'form',class:'input_form',action:'#',child:_login_vw_body}]};var _view03_sub01=[{type:'inp-text',rows:10,class:'inp-required',name:'name',placeholder:'名称と説明',label:{text:'名称／説明',class:'title'}},{type:'inp-select',name:'manager_id',options:[{value:1,text:'全員'}],label:{text:'管理者',class:'title'}},{type:'inp-cbx',id:'m02-s-opt1',name:'opened',cbx_label:{text:'公開する'},label:{text:'公開',class:'title'}},{type:'inp-cbx',id:'m02-s-opt2',name:'alive',cbx_label:{text:'進行中'},label:{text:'状態',class:'title'}}];var _view03_sub02=[{type:'inp-text',readonly:true,name:'id',label:{text:'プロジェクトID',class:'title'}},{type:'inp-text',readonly:true,name:'last_update',label:{text:'更新日時',class:'title'}}];var _view03_sub03=[{type:'inp-submit',id:'btn-new-project',text:'登録'},{type:'inp-submit',id:'btn-upd-project',text:'更新'},{type:'inp-reset',text:'クリア'}];var _view03={title:'new project view',root:'view03',child:[{type:'h4',text:'プロジェクトメンテナンス',class:'page-title'},{type:'form',class:'input_form',action:'#',child:[{type:'block',child:[{type:'block',class:'form-inp-area-2',child:_view03_sub01},{type:'block',id:'project-upd-key',child:_view03_sub02}]},{type:'block',class:'form-btn-area',child:_view03_sub03}]}]};var _view02={title:'project list view',root:'view02',child:[{type:'h4',text:'プロジェクト一覧',class:'page-title'},{type:'block',id:'prj-list-wrapper',child:[]}]};var _view04_sub01=[{type:'inp-text',rows:10,name:'title',placeholder:'タイトルと説明',class:'inp-required',label:{text:'タイトルと説明',class:'title'}},{type:'inp-date',name:'start_date',label:{text:'開始日',class:'title'}},{type:'inp-date',name:'finish_date',label:{text:'完了日',class:'title'}},{type:'inp-select',name:'kind_id',options:[],label:{text:'種類',class:'title'}},{type:'inp-select',name:'priority_id',options:[],label:{text:'優先順位',class:'title'}},{type:'inp-select',name:'status_id',options:[],label:{text:'状態',class:'title'}},{type:'inp-select',name:'progress_id',options:[],label:{text:'進捗',class:'title'}}];var _view04_sub02=[{type:'inp-text',readonly:true,name:'id',label:{text:'チケットID',class:'title'}},{type:'inp-text',readonly:true,name:'version',label:{text:'バージョン',class:'title'}},{type:'inp-text',readonly:true,name:'last_update',label:{text:'更新日時',class:'title'}}];var _view04_sub03=[{type:'inp-submit',id:'btn-new-ticket',text:'登録'},{type:'inp-submit',id:'btn-upd-ticket',text:'更新'},{type:'inp-reset',text:'クリア'}];var _view04={title:'ticket view',root:'view04',child:[{type:'h4',text:'チケットメンテナンス',class:'page-title'},{type:'block',class:'read_only header_title'},{type:'form',class:'input_form',action:'#',child:[{type:'block',child:[{type:'block',class:'form-inp-area-2',child:_view04_sub01},{type:'block',id:'ticket-upd-key',child:_view04_sub02}]},{type:'block',class:'form-btn-area',child:_view04_sub03}]}]};var _view01={title:'ticket search view',root:'view01',child:[{type:'h4',text:'チケット検索',class:'page-title'},{type:'form',class:'input_form',action:'#',child:[{type:'block',class:'form-inp-area',child:[{type:'inp-text',name:'p01-s-title',placeholder:'タイトルの一部を入力',label:{text:'タイトル',class:'title'}},{type:'inp-text',name:'p01-s-desc',placeholder:'説明の一部を入力',label:{text:'説明',class:'title'}},{type:'inp-date',name:'p01-s-date-fm',label:{text:'開始日(from)',class:'title'}},{type:'inp-date',name:'p01-s-date-to',label:{text:'開始日(to)',class:'title'}},{type:'inp-cbx',id:'p01-s-opt1',name:'p01-s-opt1',cbx_label:{text:'含む'},label:{text:'完了分',class:'title'}}]}]}]};var app_header={title:'application header',root:'app_header',child:[{type:'block',class:'app_header_body',child:[{type:'block',class:'app_header_title',child:[{type:'h2',text:'チケットLite'}]},{type:'block',id:'menu_body',child:[{type:'block',id:'humberger',child:[{type:'block'},{type:'block'},{type:'block'}]}]}]}]};var view_defs=[_login_view,_view01,_view02,_view03,_view04];var page_defs=[{title:'page defs',root:'ap_contents',child:[{type:'block',id:'popup_bg',class:'page page_hidden'},{type:'block',id:'login',class:'page page_hidden'},{type:'block',id:'view01',class:'page page_hidden'},{type:'block',id:'view02',class:'page page_hidden'},{type:'block',id:'view03',class:'page page_hidden'},{type:'block',id:'view04',class:'page page_hidden'}]}];var view_root={title:'view root',root:'body',child:[{type:'block',id:'app_header'},{type:'block',id:'ap_contents'}]};function MyApp(apConfig){this.apConfig=apConfig;this.event={};this.fw=undefined;};MyApp.prototype.start=function(self){var fw=self.fw;fw.make_views(fw,[view_root]);fw.make_views(fw,[app_header]);fw.make_views(fw,page_defs);fw.make_views(fw,view_defs);var cf=self.apConfig;var elm=document.getElementById(cf.start_page_id);elm.classList.toggle(cf.page_deactivate_class);cf.active_page=elm;cf.other_view=document.getElementById('menu_body');};MyApp.prototype.hideElement=function(self,elmId){var elm=document.querySelector('#'+elmId);elm.classList.add(self.apConfig.page_deactivate_class);};MyApp.prototype.showElement=function(self,elmId){var elm=document.querySelector('#'+elmId);elm.classList.remove(self.apConfig.page_deactivate_class);};MyApp.prototype.changePage=function(self,target){var pgId=target.dataset.page;if(!pgId){console.log('target not found(1)at changePage');return;}if(!self.changePageById(self,pgId)){console.log('target not found(2)at changePage');}};MyApp.prototype.changePageById=function(self,elmId){var elm=self.fw.findElement(self.fw,elmId);if(!elm){console.log(elmId+'not found');return false;}self.changePageByElement(self,elm);return true;};MyApp.prototype.changePageByElement=function(self,elm){var cf=self.apConfig;elm.classList.toggle(cf.page_deactivate_class);var curPg=self.apConfig.active_page;curPg.classList.toggle(cf.page_deactivate_class);cf.active_page=elm;};MyApp.prototype.showPopup=function(self,tagDef){var curtain=document.querySelector('#popup_bg');curtain.textContent=null;self.fw.make_view(self.fw,{child:tagDef},curtain);var deact=self.apConfig.page_deactivate_class;curtain.classList.remove(deact);self.apConfig.popup_view=curtain;};MyApp.prototype.EM_closePopup=function(self){var curtain=document.querySelector('#popup_bg');curtain.classList.add(self.apConfig.page_deactivate_class);self.apConfig.popup_view=undefined;};MyApp.prototype.resetActivateForm=function(self){var forms=self.apConfig.active_page.getElementsByTagName('form');forms[0].reset();};MyApp.prototype.showProjectList=function(self,data){var fw=self.fw;var wrapper=document.querySelector('#prj-list-wrapper');wrapper.textContent=null;prjBoxes=[];for(var prj of data.body){var prjBox={type:'block',class:'prj-list-box',child:[]};prjBox.child.push({type:'block',class:'title',text:prj.id});prjBox.child.push({type:'block',class:'title',text:prj.name});prjBox.child.push({type:'block',class:'kind-count',text:prj.finish+'/'+prj.total});if(prj.kinds&&prj.kinds.length>0){for(var knd of prj.kinds){prjBox.child.push({type:'block',class:'title',text:''});prjBox.child.push({type:'block',class:'ticket-kind',text:knd.name});prjBox.child.push({type:'block',class:'kind-count',text:knd.finish+'/'+knd.total});}}prjBoxes.push(prjBox);}if(prjBoxes.length>0){self.fw.make_view(self.fw,{child:prjBoxes},wrapper);}};MyApp.prototype.serverComm=function(self,path,body,proc){var txData={header:self.apConfig.request_header,body:body};self.fw.ajax(self.fw,{url:self.apConfig.server_uri+path,timeout:self.apConfig.comm_timer,req_data:txData,success:function(data){proc(self,data);},failure:function(message){console.log('project list failure');}});};MyApp.prototype.EM_loginStart=function(self,target){self.event['target']=targetself.serverComm(self,'login/prepare',{},self.afterLoginPrepare);};MyApp.prototype.afterLoginPrepare=function(self,rxData){if(rxData.status.result==='OK'){var fw=self.fw;var vals=fw.findFormValues(fw,self.event['target']);self.apConfig.request_header.session_id=rxData.body.session_id;self.serverComm(self,'login',vals,self.afterLogin);}else{alert('ログインに失敗しました.');}};MyApp.prototype.afterLogin=function(self,rxData){if(rxData.status.result==='OK'){self.apConfig.request_header.session_id=rxData.body.session_id;alert('ログインしました.');self.resetActivateForm(self);}else{alert('ログインに失敗しました.');}};MyApp.prototype.EM_findAllProject01=function(self,target){self.event['target']=target;self.serverComm(self,'project_list','',self.projectList01);};MyApp.prototype.projectList01=function(self,rxData){self.showProjectList(self,rxData);self.changePage(self,self.event.target);};MyApp.prototype.EM_findAllProject02=function(self,target){self.event['target']=targetself.serverComm(self,'project_list','',self.projectList02);};MyApp.prototype.projectList02=function(self,rxData){var fw=self.fw;var popDef=_vw_popup[1];var item=fw.findDictByKeyAndVal(fw,popDef,'id','popup-01-guid');item['text']='プロジェクトを選択';var lstBody=fw.findDictByKeyAndVal(fw,popDef,'id','popup-01-data');var wrap=_popup_list_01;lstBody.child=[wrap];wrap.child=[];if(rxData.body){for(var prj of rxData.body){wrap.child.push({type:'p',text:prj.id,class:'list_01_item_hide'});wrap.child.push({type:'p',text:prj.name});}}else{}self.event['operation_new']=self.EM_showNewProject;self.event['operation_upd']=self.EM_getProjectDetail;self.showPopup(self,popDef);};MyApp.prototype.EM_showNewProject=function(self){self.hideElement(self,'btn-upd-project');self.hideElement(self,'project-upd-key');self.showElement(self,'btn-new-project');self.changePage(self,self.event.target);self.resetActivateForm(self);};MyApp.prototype.EM_newProject=function(self,vals){if(vals.name==''){alert('[必須]プロジェクト名を入力して下さい');return;}var nd=self.fw.splitLine(vals.name,2);vals.name=nd[0];vals.description=nd[1];vals.alive=vals.alive?'on':'off';vals.opened=vals.opened?'on':'off';self.serverComm(self,'new_project',vals,self.newProjectResult);};MyApp.prototype.newProjectResult=function(self,rxData){if(rxData.status.result==='OK'){alert('プロジェクトを登録しました.');self.resetActivateForm(self);}else{alert('プロジェクトの登録失敗.\n\n'+rxData.status.message);}};MyApp.prototype.EM_isListSelected=function(self){var lstWrp=document.querySelector('#popup_list_01');var c=lstWrp.children;for(var idx=1;idx<c.length;idx+=2){var elm=c[idx];if(elm.classList.contains('popup-01-list-select')){elm=c[idx-1];return elm.innerText;}}return undefined;};MyApp.prototype.EM_getProjectDetail=function(self,pid){var req={project_id:Number(pid)};self.serverComm(self,'project_detail',req,self.projectDetailResult);};MyApp.prototype.projectDetailResult=function(self,rxData){self.hideElement(self,'btn-new-project');self.showElement(self,'btn-upd-project');self.showElement(self,'project-upd-key');var vals=rxData.body;vals.alive=vals.alive==='on'?true:false;vals.opened=vals.opened==='on'?true:false;if(vals.description){vals.name=vals.name+'\n'+vals.description;}var elm=document.querySelector('#btn-upd-project');self.fw.storeFormValues(self.fw,elm,vals);self.changePage(self,self.event.target);self.EM_closePopup(self);};MyApp.prototype.EM_editProject=function(self,vals){if(vals.name==''){alert('[必須]プロジェクト名を入力して下さい');return;}var nd=self.fw.splitLine(vals.name,2);vals.name=nd[0];vals.description=nd[1];vals.alive=vals.alive?'on':'off';vals.opened=vals.opened?'on':'off';self.serverComm(self,'edit_project',vals,self.editProjectResult);};MyApp.prototype.editProjectResult=function(self,rxData){if(rxData.status.result==='OK'){alert('更新しました.');}else{alert('更新失敗.\n\n'+rxData.status.message);}};MyApp.prototype.EM_selectTicketProject=function(self,target,vals){var pid=Number(vals.project_id);self.event['project_id']=pid;self.event['project_name']=vals.project_name;self.serverComm(self,'ticket_list',{project_id:pid},self.selectTicketProjectResult);};MyApp.prototype.selectTicketProjectResult=function(self,rxData){if(rxData.status.result!=='OK'){alert('取得失敗.\n\n'+rxData.status.message);}var fw=self.fw;var popDef=_vw_popup[1];var item=fw.findDictByKeyAndVal(fw,popDef,'id','popup-01-guid');item['text']='チケットを選択';var lstBody=fw.findDictByKeyAndVal(fw,popDef,'id','popup-01-data');var wrap=_popup_list_01;lstBody.child=[wrap];wrap.child=[];if(rxData.body){for(var tkt of rxData.body){wrap.child.push({type:'p',text:tkt.id,class:'list_01_item_hide'});wrap.child.push({type:'p',text:tkt.title});}}else{}self.event['operation_new']=self.EM_showNewTicket;self.event['operation_upd']=self.EM_getTicketDetail;self.showPopup(self,popDef);};MyApp.prototype.EM_showNewTicket=function(self){var req={project_id:self.event['project_id']};self.serverComm(self,'ticket_master',req,self.ticketMasterResult);};MyApp.prototype.ticketMasterResult=function(self,rxData){if(rxData.status.result!=='OK'){alert('チケットマスタ取得失敗.\n\n'+rxData.status.message);}self.showElement(self,'btn-new-ticket');self.hideElement(self,'ticket-upd-key');self.hideElement(self,'btn-upd-ticket');var pgElm=self.fw.findElement(self.fw,'#view04');var name=pgElm.querySelectorAll('.read_only');name[0].innerText=self.event['project_name'];self.initTicketSelector(self,pgElm,rxData.body.master);self.changePageByElement(self,pgElm);self.resetActivateForm(self);};MyApp.prototype.initTicketSelector=function(self,pgElm,mstData){var optList=pgElm.querySelectorAll('select');var fw=self.fw;for(var elm of optList){if(elm.name==='kind_id'){self.setSelectorOptions(fw,elm,mstData.kind);}else if(elm.name==='priority_id'){self.setSelectorOptions(fw,elm,mstData.priority);}else if(elm.name==='status_id'){self.setSelectorOptions(fw,elm,mstData.status);}else if(elm.name==='progress_id'){self.setSelectorOptions(fw,elm,mstData.progress);}}};MyApp.prototype.setSelectorOptions=function(fw,elm,vals){elm.textContent=null;var attr={value:undefined,text:''};var opt=fw.createSelectorOption(fw,attr);elm.appendChild(opt);for(var item of vals){attr={value:Number(item.id),text:item.name};opt=fw.createSelectorOption(fw,attr);elm.appendChild(opt);}elm.selectedIndex=0;};MyApp.prototype.EM_newTicket=function(self,vals){if(vals.title==''){alert('[必須]チケットタイトルを入力して下さい');return;}vals=self.editTicketRequest(self,vals);self.serverComm(self,'new_ticket',vals,self.newTicketResult);};MyApp.prototype.editTicketRequest=function(self,vals){vals['project_id']=self.event['project_id'];var nd=self.fw.splitLine(vals.title,2);vals.title=nd[0];vals.description=nd[1];for(key in vals){if(vals[key]==='undefined'){vals[key]=null;}else if(vals[key]===''){vals[key]=null;}}return vals;};MyApp.prototype.newTicketResult=function(self,rxData){if(rxData.status.result==='OK'){alert('チケットを登録しました.');self.resetActivateForm(self);}else{alert('チケットの登録失敗.\n\n'+rxData.status.message);}};MyApp.prototype.EM_getTicketDetail=function(self,tid){console.log('todo EM_getTicketDetail');var req={ticket_id:Number(tid)};self.serverComm(self,'ticket_detail',req,self.ticketDetailResult);};MyApp.prototype.ticketDetailResult=function(self,rxData){self.hideElement(self,'btn-new-ticket');self.showElement(self,'ticket-upd-key');self.showElement(self,'btn-upd-ticket');var pgElm=self.fw.findElement(self.fw,'#view04');var name=pgElm.querySelectorAll('.read_only');name[0].innerText=self.event['project_name'];self.initTicketSelector(self,pgElm,rxData.body.master);tinfo=rxData.body.ticket;if(tinfo.description){tinfo.title=tinfo.title+'\n'+tinfo.description;}var elm=document.querySelector('#btn-upd-ticket');self.fw.storeFormValues(self.fw,elm,tinfo);self.changePageByElement(self,pgElm);self.EM_closePopup(self);};MyApp.prototype.EM_editTicket=function(self,vals){if(vals.title==''){alert('[必須]チケットタイトルを入力して下さい');return;}vals=self.editTicketRequest(self,vals);self.serverComm(self,'edit_ticket',vals,self.editTicketResult);};MyApp.prototype.editTicketResult=function(self,rxData){if(rxData.status.result==='OK'){alert('チケットを更新しました.');self.resetActivateForm(self);}else{alert('チケットの更新失敗.\n\n'+rxData.status.message);}};var _evtMap=[];_evtMap.push({type:'load',process:function(fw,evt,app){app.start(app);}});_evtMap.push({type:'click',id_targets:['btn-login'],process:function(fw,evt,target,app){app.EM_loginStart(app,target);}});_evtMap.push({type:'click',id_targets:['humberger'],process:function(fw,evt,target,app){if(app.apConfig.popup_view){app.EM_closePopup(app);}else{app.showPopup(app,_vw_popup[0]);}}});_evtMap.push({type:'click',id_targets:['hm_p_stat'],process:function(fw,evt,target,app){app.EM_findAllProject02(app,target);}});_evtMap.push({type:'click',id_targets:['hm_project'],process:function(fw,evt,target,app){app.EM_findAllProject01(app,target);app.EM_closePopup(app);}});_evtMap.push({type:'click',id_targets:['hm_search','hm_user','hm_role','hm_t_stat','hm_t_kind','hm_t_prgs','hm_t_pri'],process:function(fw,evt,target,app){app.changePage(app,target);app.EM_closePopup(app)}});_evtMap.push({type:'click',id_targets:['popup-01-data'],process:function(fw,evt,target,app){var y=evt.clientY;var c=target.firstElementChild;for(var idx=1;idx<c.children.length;idx+=2){var elm=c.children[idx];var rect=elm.getBoundingClientRect();if((rect.top<=y)&&(y<=rect.bottom)){elm.classList.add('popup-01-list-select');}else{elm.classList.remove('popup-01-list-select');}}}});_evtMap.push({type:'click',class_targets:['prj-list-box'],process:function(fw,evt,target,app){var vals={};var elm=target.firstElementChild;vals.project_id=Number(elm.innerText);elm=elm.nextElementSibling;vals.project_name=elm.innerText;app.EM_selectTicketProject(app,target,vals);}});_evtMap.push({type:'click',id_targets:['popup-01-new'],process:function(fw,evt,target,app){app.event['operation_new'](app);app.EM_closePopup(app);}});_evtMap.push({type:'click',id_targets:['popup-01-update'],process:function(fw,evt,target,app){var did=app.EM_isListSelected(app);if(!did){alert('更新対象を選択してください.');return;}app.event['operation_upd'](app,did);}});_evtMap.push({type:'click',id_targets:['btn-new-project'],process:function(fw,evt,target,app){var vals=fw.findFormValues(fw,target);app.EM_newProject(app,vals);}});_evtMap.push({type:'click',id_targets:['btn-upd-project'],process:function(fw,evt,target,app){var vals=fw.findFormValues(fw,target);app.EM_editProject(app,vals);}});_evtMap.push({type:'click',id_targets:['btn-new-ticket'],process:function(fw,evt,target,app){var vals=fw.findFormValues(fw,target);app.EM_newTicket(app,vals);}});_evtMap.push({type:'click',id_targets:['btn-upd-ticket'],process:function(fw,evt,target,app){var vals=fw.findFormValues(fw,target);app.EM_editTicket(app,vals);}});var _ap_config={start_page_id:'login',page_deactivate_class:'page_hidden',event_map:_evtMap,active_page:undefined,popup_view:undefined,other_view:undefined,server_uri:'http://127.0.0.1:8080/',request_header:{app_name:'Ticket Lite for Web',app_ver:'0.0.1',session_id:undefined},comm_timer:10000,isDebug:true};var myApp=new MyApp(_ap_config);function FwLite(app){this.app=app;app.fw=this;};FwLite.prototype.splitLine=function(source,lnCnt){var wk=source.split(/\r\n|\n/);var wkln=wk.length;if(lnCnt==wkln){return wk;}else if(wkln<lnCnt){for(var i=0;i<(lnCnt-wkln);++i){wk.push('');}return wk;}var r=[];for(var i=1;i<lnCnt;++i){r.push(wk.shift());}r.push(wk.join('\n'));return r;};FwLite.prototype.getFormValues=function(self,pElm,vals){for(var idx=0;idx<pElm.children.length;++idx){var elm=pElm.children[idx];if(elm.name){if(elm.type.toLowerCase()==='checkbox'){vals[elm.name]=elm.checked;}else{vals[elm.name]=elm.value;}}if(elm.firstElementChild){vals=self.getFormValues(self,elm,vals);}}return vals;};FwLite.prototype.setFormValues=function(self,pElm,vals){var list=pElm.querySelectorAll('[name]');list.forEach(function(elm){if(elm.name in vals){if(elm.type.toLowerCase()==='checkbox'){elm.checked=vals[elm.name];}else{elm.value=vals[elm.name];}}});};FwLite.prototype.findDictByKeyAndVal=function(self,ary,key,val){for(var item of ary){if(key in item){if(item[key]==val)return item;}}if('child'in item){return self.findDictByKeyAndVal(self,item.child,key,val);}return undefined;};FwLite.prototype.findParentTag=function(startTag,tagName){if(tagName===startTag.nodeName.toLowerCase()){return startTag;}else{var fElm=startTag.parentNode;while(tagName!==fElm.nodeName.toLowerCase())fElm=fElm.parentNode;}return fElm;};FwLite.prototype.findFormValues=function(self,tag){var fElm=self.findParentTag(tag,'form');return self.getFormValues(self,fElm,{});};FwLite.prototype.storeFormValues=function(self,tag,vals){var fElm=self.findParentTag(tag,'form');return self.setFormValues(self,fElm,vals);};FwLite.prototype.setAttributes=function(elm,attr){if('class'in attr){elm.classList=attr.class;}if('id'in attr){elm.id=attr.id;}if('data'in attr){var dt=attr.data;for(key in dt){elm.dataset[key]=dt[key];}}return elm;};FwLite.prototype.setInputAttributes=function(elm,attr){if('name'in attr){elm.name=attr.name;}if('readonly'in attr){elm.readOnly=attr.readonly;}return elm;};FwLite.prototype.createElement=function(self,elmName,attr){var elm=document.createElement(elmName);if(attr)return self.setAttributes(elm,attr);return elm;};FwLite.prototype.createBlockElement=function(self,attr){var elm=self.createElement(self,'div',attr);if('text'in attr)elm.innerText=attr.text;return elm;};FwLite.prototype.createFormElement=function(self,attr){var elm=self.createElement(self,'form',attr);if('action'in attr)elm.action=attr.action;return elm;};FwLite.prototype.createInputElement=function(self,attr,inpType){var elm=self.createElement(self,'input',attr);self.setInputAttributes(elm,attr);elm.type=inpType;if('placeholder'in attr)elm.placeholder=attr.placeholder;if('value'in attr)elm.value=attr.value;if('readonly'in attr)elm.readOnly=attr.readonly;return elm;};FwLite.prototype.createTextareaElement=function(self,attr,inpType){var elm=self.createElement(self,'textarea',attr);self.setInputAttributes(elm,attr);if('placeholder'in attr)elm.placeholder=attr.placeholder;if('value'in attr)elm.value=attr.value;if('readonly'in attr)elm.readOnly=attr.readonly;elm.rows=attr.rows;return elm;};FwLite.prototype.createCheckboxElement=function(self,attr){var pElm=self.createBlockElement(self,{});var elm=self.createElement(self,'input',attr);elm.type='checkbox';self.setInputAttributes(elm,attr);if(attr.checked)elm.checked=true;pElm.appendChild(elm);if('cbx_label'in attr){var lblAttr={text:attr.cbx_label.text};if('id'in attr)lblAttr['for']=attr.id;pElm.appendChild(self.createLabelElement(self,lblAttr));}return pElm;};FwLite.prototype.createLabelElement=function(self,attr){var elm=self.createElement(self,'label',attr);if('for'in attr)elm.htmlFor=attr.for;elm.innerText=attr.text;return elm;};FwLite.prototype.createFormLabelElement=function(self,attr){var lblAttr=attr.label;if('id'in attr)lblAttr.for=attr.id;return self.createLabelElement(self,lblAttr);};FwLite.prototype.createInputDateElement=function(self,attr){var elm=self.createElement(self,'input',attr);elm.type='date';self.setInputAttributes(elm,attr);if('placeholder'in attr){elm.placeholder=attr.placeholder;}if('value'in attr){elm.value=attr.value;}return elm;};FwLite.prototype.createButtonElement=function(self,attr,type){var elm=self.createElement(self,'button',attr);elm.type=type;if('text'in attr)elm.innerText=attr.text;return elm;};FwLite.prototype.createDefinitionList=function(self,attr){var elm=self.createElement(self,'dl',attr);for(chunk of attr.child){var dt=self.createElement(self,'dt',chunk);dt.innerText=chunk.text;elm.appendChild(dt);for(item of chunk.items){var dd=self.createElement(self,'dd',item);dd.innerText=item.text;elm.appendChild(dd);}}return elm;};FwLite.prototype.createSelectorOption=function(self,attr){var opt=self.createElement(self,'option',attr);opt.value=attr.value;opt.innerText=attr.text;return opt;};FwLite.prototype.createSelectorElement=function(self,attr){var elm=self.createElement(self,'select',attr);self.setInputAttributes(elm,attr);for(var optItm of attr.options){var opt=self.createSelectorOption(self,optItm);elm.appendChild(opt);}return elm;};FwLite.prototype.make_view=function(self,vw,pelm){var rootElm;if('root'in vw){rootElm=document.getElementById(vw.root);}else{rootElm=pelm;}var elm;for(pt of vw.child){var ptTyp=pt.type;if(ptTyp=='block'){elm=self.createBlockElement(self,pt);}else if(ptTyp=='form'){elm=self.createFormElement(self,pt);}else if(ptTyp=='inp-text'){if('rows'in pt){elm=self.createTextareaElement(self,pt);}else{elm=self.createInputElement(self,pt,'text');}}else if(ptTyp=='inp-passwd'){elm=self.createInputElement(self,pt,'password');}else if(ptTyp=='inp-cbx'){elm=self.createCheckboxElement(self,pt);}else if(ptTyp=='inp-date'){elm=self.createInputDateElement(self,pt);}else if(ptTyp=='inp-submit'){elm=self.createButtonElement(self,pt,'button');}else if(ptTyp=='inp-reset'){elm=self.createButtonElement(self,pt,'reset');}else if(ptTyp=='inp-button'){elm=self.createButtonElement(self,pt,'button');}else if(ptTyp=='inp-select'){elm=self.createSelectorElement(self,pt);}else if(ptTyp=='def-list'){elm=self.createDefinitionList(self,pt);rootElm.appendChild(elm);continue;}else{elm=self.createElement(self,ptTyp,pt);if('text'in pt)elm.innerText=pt.text;}if('label'in pt){var lblElm=self.createFormLabelElement(self,pt);rootElm.appendChild(lblElm);}if('child'in pt){self.make_view(self,pt,elm);}rootElm.appendChild(elm);}};FwLite.prototype.make_views=function(self,defs){for(vw of defs){console.log('make['+vw.title+']');self.make_view(self,vw);}};FwLite.prototype.inRect=function(x,y,elmRect){var x2=elmRect.x+elmRect.width;var y2=elmRect.y+elmRect.height;if((elmRect.x<=x)&&(x<=x2)&&(elmRect.y<=y)&&(y<=y2)){return true;}return false;};FwLite.prototype.evtExecuterById=function(self,evt,elm){var id=elm.id;for(var item of self.app.apConfig.event_map){if('id_targets'in item){if(item.id_targets.indexOf(id)!=-1){console.log('start id:'+id);item.process(self,evt,elm,self.app);self.evtExecFlag=true;}}}};FwLite.prototype.evtExecuterByClass=function(self,evt,elm){var clsList=elm.classList;for(var item of self.app.apConfig.event_map){if('class_targets'in item){for(var cls of item.class_targets){if(clsList.contains(cls)){item.process(self,evt,elm,self.app);self.evtExecFlag=true;}}}}};FwLite.prototype.executeEventByXY=function(self,evt,pElm){for(var idx=0;idx<pElm.children.length;++idx){var elm=pElm.children[idx];if(elm.clientHeight==0||elm.clientWidth==0)continue;var rect=elm.getBoundingClientRect();if(self.inRect(evt.clientX,evt.clientY,rect)){if(elm.id){self.evtExecuterById(self,evt,elm);}else if(elm.classList.length>0){self.evtExecuterByClass(self,evt,elm);}}if(elm.children){self.executeEventByXY(self,evt,elm);}}};FwLite.prototype.evtCatcher=function(self,evt){if(evt.type=='load'){self.executeEventByType(self,evt);}else{self.evtExecFlag=false;var elm=self.app.apConfig.popup_view;if(elm){self.executeEventByXY(self,evt,elm);if(self.evtExecFlag)return;}var elm=self.app.apConfig.active_page;if(elm){self.executeEventByXY(self,evt,elm);if(self.evtExecFlag)return;}var elm=self.app.apConfig.other_view;if(elm){self.executeEventByXY(self,evt,elm);if(self.evtExecFlag)return;}}};FwLite.prototype.executeEventByType=function(self,evt){for(var item of self.app.apConfig.event_map){if(evt.type==item.type){item.process(self,evt,self.app);}}};FwLite.prototype.prepare=function(self){self._ajax={status:'idle',que:new Array()};tl=self.keyList(self.app.apConfig.event_map,'type');var bodyElm=document.querySelector('#body');if(tl.indexOf('load')>=0){addEventListener('load',function(evt){setTimeout(function(){self.evtCatcher(self,evt);},0);},false);}if(tl.indexOf('click')>=0){bodyElm.addEventListener('click',function(evt){setTimeout(function(){self.evtCatcher(self,evt);},0);},false);}if(tl.indexOf('touchstart')>=0){bodyElm.addEventListener('touchstart',function(evt){setTimeout(function(){self.evtCatcher(self,evt);},0);},false);}};FwLite.prototype.keyList=function(l,k){var r=[];for(i of l){if(r.indexOf(i[k])<0)r.push(i[k]);}return r;};FwLite.prototype.findElement=function(self,tgtNm){return document.querySelector(tgtNm);};FwLite.prototype.findElements=function(self,tgtNm){return document.querySelectorAll(tgtNm);};FwLite.prototype.ajax=function(self,req){self._ajax.que.push(req);self.ajax_S100(self);};FwLite.prototype.ajax_S100=function(self){if(self._ajax.que.length==0){self._ajax.status='idle';console.log('no more ajax request');return;}setTimeout(function(){self._ajax.status='tx-101';self.ajax_S200(self);},0);};FwLite.prototype.ajax_S200=function(self){if(self._ajax.status==='tx-101'){console.log('send request');var xhr=self._ajax_getXHR(self);xhr.send(JSON.stringify(self._ajax.que[0].req_data));}else{console.log('not supportted status:'+self._ajax.status);}};FwLite.prototype._ajax_getXHR=function(self){var req=self._ajax.que[0];var xhr=new XMLHttpRequest();xhr.open('POST',req.url,true);xhr.timeout=req.timeout;xhr.setRequestHeader('Content-Type','application/json');xhr.onload=function(){self.ajax_onload(self,xhr);};xhr.onerror=function(){self.ajax_onerror(self,xhr);};xhr.onabort=function(){self.ajax_onabort(self,xhr);};xhr.ontimeout=function(){self.ajax_ontimeout(self,xhr);};return xhr;};FwLite.prototype.ajax_S300=function(self,status,xhr){if(status==='OK'){var req=self._ajax.que[0];setTimeout(function(){var data=xhr.responseText;req.success(JSON.parse(data));});}else{var req=self._ajax.que[0];setTimeout(function(){req.failure(status);});}self._ajax.que.pop();self._ajax.statis='idle';self.ajax_S100(self);};FwLite.prototype.ajax_onload=function(self,xhr){console.log('ajax_onload');if(xhr.status==200){self.ajax_S300(self,'OK',xhr);}else{self.ajax_S300(self,xhr.statusText,xhr);}};FwLite.prototype.ajax_onerror=function(self,xhr){console.log('ajax_onerror');self.ajax_S300(self,'ERROR',xhr);};FwLite.prototype.ajax_onabort=function(self,xhr){console.log('ajax_onabort');self.ajax_S300(self,'ERROR',xhr);};FwLite.prototype.ajax_ontimeout=function(self,xhr){console.log('ajax_ontimeout');self.ajax_S300(self,'TIMEOUT',xhr);};var myFw=new FwLite(myApp);myFw.prepare(myFw);